<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Details - popd</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/movie.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="/favicon.ico">
</head>
<body>
<header class="site-header">
    <div class="container">
        <div class="header-bar">
            <div class="logo-section">
                <a class="logo" href="/">
                    <img src="https://dl.dropboxusercontent.com/scl/fi/w1ql10wqc755r981aodun/Popd-logo-new.png?rlkey=ln1va7jaaqb5s8p7cqfi9d4v5&st=53c30za0"
                         alt="POPd Logo" class="logo-image">
                </a>
            </div>
            <div class="header-top">
                <div class="search-section">
                    <form class="search-bar" action="/find" method="get" role="search">
                        <input type="text" name="query"
                               placeholder="Search Movies or Artists"
                               aria-label="Search Movies or Artists">
                        <button type="submit">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </button>
                    </form>
                </div>

                <nav class="nav">
                    <span sec:authorize="isAnonymous()">
                        <a href="/login">Login</a>
                        <span class="nav-separator">|</span>
                        <a href="/register">Register</a>
                    </span>
                    <div class="dropdown" sec:authorize="isAuthenticated()">
                        <a href="/profile" class="profile-btn">
                            <i class="fa-solid fa-user"></i>
                            Profile
                            <i class="fa-solid fa-chevron-down"></i>
                        </a>
                        <div class="dropdown-menu">
                            <a href="/profile">Profile</a>
                            <form th:action="@{/logout}" method="post" class="logout-form">
                                <button type="submit" class="logout-link">Logout</button>
                            </form>
                        </div>
                    </div>
                    <span class="nav-separator" sec:authorize="hasRole('ADMIN')">|</span>
                    <div class="dropdown" sec:authorize="hasRole('ADMIN')">
                        <a href="/admin" class="profile-btn">
                            <i class="fa-solid fa-gear"></i>
                            Admin
                            <i class="fa-solid fa-chevron-down"></i>
                        </a>
                        <div class="dropdown-menu">
                            <a href="/movies/add">Add Movie</a>
                            <a href="/artist/add">Add Artist</a>
                            <a href="/admin/users">Manage Users</a>
                            <a href="/admin">Admin Panel</a>
                        </div>
                    </div>
                    <a href="/movies" class="nav-button">Movies</a>
                </nav>
            </div>
        </div>
    </div>
</header>

<main class="container">
    <section class="movie-details-section">
        <div class="movie-container">
            <!-- Movie Header -->
            <div class="movie-header"
                 th:style="${movie.backgroundImage != null and !#strings.isEmpty(movie.backgroundImage)} ? '--bg-image-url:url(' + ${movie.backgroundImage} + '); --show-overlay:1;' : '--bg-image-url:none; --show-overlay:0;'">
                <div class="movie-poster">
                    <img th:src="${movie.posterUrl != null and !#strings.isEmpty(movie.posterUrl) ? movie.posterUrl : 'https://dl.dropboxusercontent.com/scl/fi/n6js2mekqny5wlsr8pl7k/User-image-default.png?rlkey=snhcvubwp3rpko1ei3sotym0u&st=q23rykyl'}"
                         alt="Movie poster" class="poster-image">
                </div>

                <div class="movie-info">
                    <h1 class="movie-title" th:text="${movie.title}">Movie Title</h1>

                    <div class="movie-meta">
                        <div class="meta-item">
                            <i class="fas fa-calendar"></i>
                            <span th:text="${movie.releaseDate != null ? 'Release date: ' + #temporals.format(movie.releaseDate, 'MMMM dd, yyyy', T(java.util.Locale).ENGLISH) : 'N/A'}">2024</span>
                        </div>
                        <div class="meta-item">
                            <img src="https://dl.dropboxusercontent.com/scl/fi/wwhw715m7c048f2zv4bsb/popcorn.png?rlkey=54m7mxucv9d9wnyodx5j1xble&st=z6990uik"
                                 alt="Popcorn" class="popcorn-icon-small">
                            <span th:if="${averageRating != null}" th:text="${averageRating}">4.5</span>
                            <span th:if="${averageRating == null}">No ratings yet</span>
                        </div>
                    </div>

                    <div class="movie-meta-side">
                        <div class="movie-meta-left-data">
                            <div class="genres-list" th:if="${!movie.genres.isEmpty()}">
                                <span th:each="genre : ${movie.genres}" class="genre-tag"
                                      th:text="${genre.name}">Action</span>
                            </div>

                            <div class="movie-description"
                                 th:if="${movie.description != null and !#strings.isEmpty(movie.description)}">
                                <h3 class="section-title">About</h3>
                                <p class="description-text" th:text="${movie.description}">Movie description goes
                                    here.</p>
                            </div>
                        </div>

                        <!-- Movie Stats -->
                        <div class="movie-stats">
                            <div class="stat-item">
                                <span class="stat-number" th:if="${totalMovieRatingsCount == null}">0</span>
                                <span class="stat-number" th:if="${totalMovieRatingsCount != null}" th:text="${totalMovieRatingsCount}">0</span>
                                <span class="stat-label">Total Ratings</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number" th:if="${totalMovieReviewsCount == null}">0</span>
                                <span class="stat-number" th:if="${totalMovieReviewsCount != null}" th:text="${totalMovieReviewsCount}">45</span>
                                <span class="stat-label">Reviews</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number" th:text="${usersWatchedCount}">320</span>
                                <span class="stat-label">Users Watched</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="movie-actions">
                <form sec:authorize="isAuthenticated()" th:if="${!movieIsInWatchlist}"
                      th:action="@{'/movies/' + ${movie.getId()} + '/watchlist'}"
                      th:method="post" class="inline-form">
                    <button type="submit" class="action-button add-to-watchlist-button">
                        <i class="fas fa-plus-circle"></i>
                        Add to Watchlist
                    </button>
                </form>
                <form sec:authorize="isAuthenticated()" th:if="${movieIsInWatchlist}"
                      th:action="@{'/movies/' + ${movie.id} + '/delete-from-watchlist'}"
                      th:method="delete" class="inline-form">
                    <input type="hidden" name="_method" value="delete">
                    <button type="submit" class="action-button add-to-watchlist-button added-to-watchlist-button">
                        <i class="fas fa-check-circle accent-icon"></i>
                        Added to Watchlist
                    </button>
                </form>
                <form sec:authorize="isAuthenticated()" th:if="${!isWatched}"
                      th:action="@{'/movies/' + ${movie.id} + '/watched'}" th:method="post"
                      class="inline-form">
                    <button type="submit" class="action-button add-to-watched-button">
                        <i class="fas fa-check-circle"></i>
                        Mark as Watched
                    </button>
                </form>
                <form sec:authorize="isAuthenticated()" th:if="${isWatched}"
                      th:action="@{'/movies/' + ${movie.id} + '/delete-watched'}" th:method="delete"
                      class="inline-form">
                    <input type="hidden" name="_method" value="delete">
                    <button type="submit" class="action-button add-to-watched-button watched-button">
                        <i class="fas fa-eye accent-icon"></i>
                        Watched
                    </button>
                </form>

                <div sec:authorize="isAnonymous()" class="guest-actions-wrapper">
                    <a href="/login" class="action-button add-to-watchlist-button guest-watchlist-button">
                        <i class="fas fa-plus-circle"></i>
                        Log in to Manage Watchlist
                    </a>
                </div>

                <form sec:authorize="hasRole('ADMIN')" th:action="@{'/movies/' + ${movie.getId()} + '/edit'}"
                      method="get" class="inline-form">
                    <button type="submit" class="action-button edit-button">
                        <i class="fas fa-edit"></i>
                        Edit Movie
                    </button>
                </form>
            </div>
        </div>

        <div class="movie-content-section">
            <!-- Rating Section -->
            <div class="movie-rating-section">
                <div th:if="${ratingErrorMessage}" class="alert-warning" >
                    <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                    <span th:text="${ratingErrorMessage}"></span>
                </div>
                <h3 class="section-title-rating" th:text="${rating != null} ? 'Your Rating' : 'Rate This Movie'">Rate This Movie</h3>

                <div sec:authorize="isAnonymous()" class="guest-actions-wrapper">
                    <a href="/login" class="action-button add-to-watchlist-button guest-watchlist-button">
                        <i class="fas fa-plus-circle"></i>
                        Log in to Rate this Movie
                    </a>
                </div>

                <form sec:authorize="isAuthenticated()"
                      th:action="@{'/rating/' + ${movie.id} + '/add'}"
                      th:method="post"
                      class="rating-form">

                    <input type="hidden" name="${_csrf.parameterName}" th:value="${_csrf.token}">

                    <div class="rating-options"
                         th:classappend="${rating != null} ? 'has-rating' : 'no-rating'">

                        <label th:each="i : ${#numbers.sequence(10, 1, -1)}" class="rating-label">
                            <input type="radio"
                                   name="value"
                                   th:value="${i}"
                                   th:checked="${rating != null and rating == i}"
                                   class="rating-radio">
                            <button type="button"
                                    class="rating-button"
                                    th:attr="data-rating-value=${i}"
                                    th:classappend="${rating != null and rating >= i} ? ' rated' : ''">
                                <span class="rating-number" th:text="${i}">10</span>
                                <img src="https://dl.dropboxusercontent.com/scl/fi/wwhw715m7c048f2zv4bsb/popcorn.png?rlkey=54m7mxucv9d9wnyodx5j1xble&st=z6990uik"
                                     alt="Popcorn"
                                     class="popcorn-rating-icon"
                                     th:classappend="${rating != null and rating >= i} ? ' red' : ''">
                            </button>
                        </label>
                    </div>
                </form>

                <!-- show delete if rating exists -->
                <div th:if="${rating != null}" class="rating-delete-section">
                    <form th:action="@{'/rating/' + ${movie.id} + '/delete'}" method="post" class="delete-rating-form">
                        <input type="hidden" name="_method" value="delete">
                        <input type="hidden" name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <button type="submit" class="action-button delete-rating-button">
                            <i class="fas fa-trash-alt"></i>
                            Remove Rating
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="movie-container">
            <!-- Movie Credits -->
            <div class="movie-credits-section">
                <div class="credits-section">
                    <div class="credits-header">
                        <div class="credits-header-left">
                            <h2 class="credits-title">Credits</h2>
                            <a sec:authorize="hasRole('ADMIN')" th:href="'/credit/' + ${movie.id} + '/edit'"
                               class="action-button edit-credits-button">
                                <i class="fas fa-edit"></i>
                                Edit Credits
                            </a>
                        </div>
                        <select id="role-select" class="role-select">
                            <option value="ACTOR" selected>Cast</option>
                            <option value="DIRECTOR">Director</option>
                            <option value="WRITER">Writer</option>
                            <option value="PRODUCER">Producer</option>
                            <option value="CINEMATOGRAPHER">Cinematographer</option>
                            <option value="EDITOR">Editor</option>
                            <option value="COMPOSER">Composer</option>
                            <option value="COSTUME_DESIGNER">Costume Designer</option>
                            <option value="PRODUCTION_DESIGNER">Production Designer</option>
                            <option value="VISUAL_EFFECTS">Visual Effects</option>
                            <option value="SOUND_DESIGNER">Sound Designer</option>
                            <option value="MAKEUP_ARTIST">Makeup Artist</option>
                            <option value="STUNT_COORDINATOR">Stunt Coordinator</option>
                            <option value="CHOREOGRAPHER">Choreographer</option>
                            <option value="CASTING_DIRECTOR">Casting Director</option>
                        </select>
                    </div>
                    <div id="credits-list" class="credits-list">
                        <p class="no-credits-message" style="display: none;">No credits yet.</p>

                        <!-- Credit items for each role -->
                        <div th:if="${creditsByRole != null and !creditsByRole.isEmpty()}">
                            <div th:each="roleEntry : ${creditsByRole}" class="credits-images-row">
                                <div th:each="credit : ${roleEntry.value}"
                                     class="credit-item"
                                     th:attr="data-role=${roleEntry.key.name()}">
                                    <a th:href="@{'/artist/' + ${credit.artist.id}}" class="credit-link">
                                        <div class="credit-image-container">
                                            <img th:src="${credit.artist.imageUrl != null and !#strings.isEmpty(credit.artist.imageUrl) ? credit.artist.imageUrl : 'https://dl.dropboxusercontent.com/scl/fi/n6js2mekqny5wlsr8pl7k/User-image-default.png?rlkey=snhcvubwp3rpko1ei3sotym0u&st=q23rykyl'}"
                                                 th:alt="${credit.artist.name}"
                                                 class="credit-artist-image">
                                        </div>
                                        <span class="credit-artist-name"
                                              th:text="${credit.artist.name}">Artist Name</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

<!-- Reviews/Comment Section -->
        <div class="reviews-section">
            <div th:if="${reviewErrorMessage}" class="alert-warning" style="margin-bottom: 20px;">
                <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                <span th:text="${reviewErrorMessage}"></span>
            </div>
            <div class="reviews-header">
                <h3 class="section-title">User Reviews</h3>
                <a th:href="@{'/reviews/' + ${movie.id}}" class="action-button view-all-reviews-button">
                    <i class="fas fa-eye"></i>
                    View All Reviews
                </a>
            </div>
            
            <!-- My Review Section (with edit/delete buttons) -->
            <div th:if="${userReview != null}" class="my-review-section">
                <h4 class="section-title my-review-section-title">My Review</h4>
                <div class="reviews-list">
                    <div class="review-item my-review">
                        <!-- Review Display -->
                        <div class="review-display">
                            <div class="review-header">
                                <div class="reviewer-info">
                                    <span class="reviewer-name my-review-label">My Review</span>
                                    <span class="review-date" th:if="${userReview.createdOn != null and (userReview.updatedOn == null or userReview.createdOn.equals(userReview.updatedOn))}" 
                                          th:text="${' • ' + #temporals.format(userReview.createdOn, 'MMM dd, yyyy HH:mm', T(java.util.Locale).ENGLISH)}"> • Jan 15, 2024 14:30</span>
                                    <span class="review-date" th:if="${userReview.updatedOn != null and userReview.createdOn != null and !userReview.createdOn.equals(userReview.updatedOn)}" 
                                          th:text="${' • edited on ' + #temporals.format(userReview.updatedOn, 'MMM dd, yyyy HH:mm', T(java.util.Locale).ENGLISH)}"> • edited on Jan 15, 2024 14:30</span>
                                </div>
                                <div class="review-actions">
                                    <form th:action="@{'/review/' + ${movie.id} + '/edit'}" method="get" class="inline-form">
                                        <button type="submit" class="action-button edit-review-button">
                                            <i class="fas fa-edit"></i>
                                            Edit
                                        </button>
                                    </form>
                                    <form th:action="@{'/review/' + ${movie.id}}" method="post" class="delete-review-form inline-form">
                                        <input type="hidden" name="_method" value="delete">
                                        <input type="hidden" name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                        <button type="submit" class="action-button delete-review-button">
                                            <i class="fas fa-trash-alt"></i>
                                            Delete
                                        </button>
                                    </form>
                                </div>
                            </div>
                            <div class="review-content">
                                <h4 class="review-title" th:if="${userReview.title != null and !#strings.isEmpty(userReview.title)}" th:text="${userReview.title}">Review Title</h4>
                                <p th:text="${userReview.content}">Review content goes here.</p>
                            </div>
                            <!-- Mini Rating Display -->
                            <div class="mini-rating-display" th:if="${userReview.rating != null}">
                                <div class="mini-rating-popcorns">
                                    <span th:each="i : ${#numbers.sequence(1, 10)}" class="mini-popcorn-wrapper">
                                        <img src="https://dl.dropboxusercontent.com/scl/fi/wwhw715m7c048f2zv4bsb/popcorn.png?rlkey=54m7mxucv9d9wnyodx5j1xble&st=z6990uik"
                                             alt="Popcorn"
                                             class="mini-popcorn-icon"
                                             th:classappend="${userReview.rating >= i} ? ' rated' : ''">
                                    </span>
                                </div>
                            </div>
                            <div class="mini-rating-display" th:if="${userReview.rating == null}">
                                <span class="no-rating-text">No rating yet</span>
                            </div>
                        </div>
                        
                        <!-- Edit Form (hidden by default) -->
                        <div class="review-edit-form" style="display: none;">
                            <form class="review-form" th:action="@{'/review/' + ${movie.id}}" method="post">
                                <input type="hidden" name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                <input type="text" name="title" class="review-title-input" th:value="${userReview.title}" placeholder="Review Title (optional)">
                                <textarea class="review-textarea" name="content" required th:text="${userReview.content}"></textarea>
                                
                                <!-- Mini Rating Display (read-only) -->
                                <div class="mini-rating-display-form">
                                    <label class="mini-rating-label">Your Rating:</label>
                                    <div class="mini-rating-popcorns" th:if="${userReview.rating != null}">
                                        <span th:each="i : ${#numbers.sequence(1, 10)}" class="mini-popcorn-wrapper">
                                            <img src="https://dl.dropboxusercontent.com/scl/fi/wwhw715m7c048f2zv4bsb/popcorn.png?rlkey=54m7mxucv9d9wnyodx5j1xble&st=z6990uik"
                                                 alt="Popcorn"
                                                 class="mini-popcorn-icon"
                                                 th:classappend="${userReview.rating >= i} ? ' rated' : ''">
                                        </span>
                                    </div>
                                    <div class="mini-rating-popcorns" th:if="${userReview.rating == null}">
                                        <span class="no-rating-text">No rating yet</span>
                                    </div>
                                </div>
                                
                                <div class="review-form-buttons">
                                    <button type="submit" class="action-button submit-review-button">
                                        <i class="fas fa-save"></i>
                                        Save
                                    </button>
                                    <button type="button" class="action-button cancel-edit-button" onclick="toggleEditReview()">
                                        <i class="fas fa-times"></i>
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Latest Reviews Section (Latest 5, including user's review without edit/delete buttons) -->
            <div class="latest-reviews-section" th:if="${latestFiveReviews != null and !latestFiveReviews.isEmpty()}">
                <h4 class="section-title latest-reviews-section-title">Latest Reviews</h4>
                <div class="reviews-list">
                    <div th:each="review : ${latestFiveReviews}" class="review-item">
                        <div class="review-header">
                            <div class="reviewer-info">
                                <a th:href="@{'/users/' + ${review.userId}}" class="reviewer-name-link">
                                    <span class="reviewer-name" 
                                          th:classappend="${userReview != null and review.userId == userReview.userId} ? 'my-review-label' : ''"
                                          th:text="${userIdToUsernameMap.get(review.userId)}">Username</span>
                                </a>
                                <span class="review-date" th:if="${review.createdOn != null and (review.updatedOn == null or review.createdOn.equals(review.updatedOn))}" 
                                      th:text="${' • ' + #temporals.format(review.createdOn, 'MMM dd, yyyy HH:mm', T(java.util.Locale).ENGLISH)}"> • Jan 15, 2024 14:30</span>
                                <span class="review-date" th:if="${review.updatedOn != null and review.createdOn != null and !review.createdOn.equals(review.updatedOn)}" 
                                      th:text="${' • edited on ' + #temporals.format(review.updatedOn, 'MMM dd, yyyy HH:mm', T(java.util.Locale).ENGLISH)}"> • edited on Jan 15, 2024 14:30</span>
                            </div>
                        </div>
                        <div class="review-content">
                            <h4 class="review-title" th:if="${review.title != null and !#strings.isEmpty(review.title)}" th:text="${review.title}">Review Title</h4>
                            <p th:text="${review.content}">Review content goes here.</p>
                        </div>
                        <!-- Mini Rating Display -->
                        <div class="mini-rating-display" th:if="${review.rating != null}">
                            <div class="mini-rating-popcorns">
                                <span th:each="i : ${#numbers.sequence(1, 10)}" class="mini-popcorn-wrapper">
                                    <img src="https://dl.dropboxusercontent.com/scl/fi/wwhw715m7c048f2zv4bsb/popcorn.png?rlkey=54m7mxucv9d9wnyodx5j1xble&st=z6990uik"
                                         alt="Popcorn"
                                         class="mini-popcorn-icon"
                                         th:classappend="${review.rating >= i} ? ' rated' : ''">
                                </span>
                            </div>
                        </div>
                        <div class="mini-rating-display" th:if="${review.rating == null}">
                            <span class="no-rating-text">No rating yet</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Review Form (only show if user doesn't have a review) -->
            <div class="review-form-section" th:if="${userReview == null}" sec:authorize="isAuthenticated()">
                <div th:if="${reviewContentError}" class="alert-warning" style="margin-bottom: 20px;">
                    <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                    <span th:text="${reviewContentError}"></span>
                </div>
                <h4 class="section-title review-form-title">Write a Review</h4>
                <form class="review-form" th:action="@{'/review/' + ${movie.id}}" method="post">
                    <input type="hidden" name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <input type="text" name="title" class="review-title-input" placeholder="Review Title (optional)">
                    <textarea class="review-textarea" name="content"
                              placeholder="Share your thoughts about this movie..." required></textarea>
                    
                    <!-- Mini Rating Display (read-only) -->
                    <div class="mini-rating-display-form">
                        <label class="mini-rating-label">Your Rating:</label>
                        <div class="mini-rating-popcorns" th:if="${rating != null}">
                            <span th:each="i : ${#numbers.sequence(1, 10)}" class="mini-popcorn-wrapper">
                                <img src="https://dl.dropboxusercontent.com/scl/fi/wwhw715m7c048f2zv4bsb/popcorn.png?rlkey=54m7mxucv9d9wnyodx5j1xble&st=z6990uik"
                                     alt="Popcorn"
                                     class="mini-popcorn-icon"
                                     th:classappend="${rating >= i} ? ' rated' : ''">
                            </span>
                        </div>
                        <div class="mini-rating-popcorns" th:if="${rating == null}">
                            <span class="no-rating-text">No rating yet</span>
                        </div>
                    </div>
                    
                    <button type="submit" class="action-button submit-review-button">
                        <i class="fas fa-paper-plane"></i>
                        Submit Review
                    </button>
                </form>
            </div>
            <div class="review-login-prompt" sec:authorize="isAnonymous()">
                <a href="/login" class="action-button submit-review-button">
                    <i class="fas fa-paper-plane"></i>
                    Log in to Write a Review
                </a>
            </div>
        </div>

    </section>
</main>

<footer class="site-footer">
    <div class="container">
        <p>&copy; <span>2025</span> popd</p>
    </div>
</footer>

<script>
    // Credits filtering functionality + AJAX form handling
    document.addEventListener('DOMContentLoaded', function () {
        const roleSelect = document.getElementById('role-select');
        const creditsList = document.getElementById('credits-list');

        if (roleSelect && creditsList) {
            const creditItems = creditsList.querySelectorAll('.credit-item');
            const noCreditsMessage = creditsList.querySelector('.no-credits-message');

            function filterCredits(selectedRole) {
                if (!selectedRole) {
                    return;
                }

                creditItems.forEach(item => {
                    item.style.display = 'none';
                });

                if (noCreditsMessage) {
                    noCreditsMessage.style.display = 'none';
                }

                let foundCredits = false;
                creditItems.forEach(item => {
                    if (item.getAttribute('data-role') === selectedRole) {
                        item.style.display = 'flex';
                        foundCredits = true;
                    }
                });

                if (!foundCredits && noCreditsMessage) {
                    noCreditsMessage.style.display = 'block';
                }
            }

            roleSelect.addEventListener('change', function () {
                filterCredits(this.value);
            });

            filterCredits(roleSelect.value);
        }

        const storedScrollY = sessionStorage.getItem('movieScrollY');
        if (storedScrollY !== null) {
            window.scrollTo(0, parseInt(storedScrollY, 10));
            sessionStorage.removeItem('movieScrollY');
        }

        const ajaxFormSelectors = [
            'form.inline-form[action*="/watchlist"]',
            'form.inline-form[action*="/watched"]',
            'form.inline-form[action*="/delete-from-watchlist"]',
            'form.inline-form[action*="/delete-watched"]',
            'form.delete-form[action*="/credit/"]',
            'form.rating-form[action*="/rating/"]',
            'form.delete-rating-form[action*="/rating/"]',
            'form.review-form[action*="/review/"]',
            'form.delete-review-form[action*="/review/"]'
        ];

        const ajaxForms = document.querySelectorAll(ajaxFormSelectors.join(', '));

        ajaxForms.forEach(form => {
            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                // Validate review form content before submitting
                if (form.classList.contains('review-form')) {
                    const contentField = form.querySelector('textarea[name="content"]');
                    if (contentField) {
                        const content = contentField.value;
                        if (!content || content.trim().length === 0) {
                            const errorMessage = "Content cannot be empty or contain only whitespace";
                            const errorDiv = document.createElement('div');
                            errorDiv.classList.add('alert-warning');
                            errorDiv.style.marginBottom = '20px';
                            errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i> ${errorMessage}`;
                            
                            const reviewFormSection = form.closest('.review-form-section');
                            if (reviewFormSection) {
                                const existingError = reviewFormSection.querySelector('.alert-warning');
                                if (existingError) {
                                    existingError.remove();
                                }
                                const formTitle = reviewFormSection.querySelector('.review-form-title');
                                if (formTitle) {
                                    reviewFormSection.insertBefore(errorDiv, formTitle);
                                } else {
                                    reviewFormSection.prepend(errorDiv);
                                }
                            }
                            return;
                        }
                    }
                }

                const submitButton = form.querySelector('button[type="submit"]');
                const originalButtonContent = submitButton ? submitButton.innerHTML : null;

                if (submitButton) {
                    submitButton.disabled = true;
                }

                try {
                    const formData = new FormData(form);
                    const urlEncodedData = new URLSearchParams();
                    for (const [key, value] of formData.entries()) {
                        urlEncodedData.append(key, value);
                    }

                    console.log('Form action:', form.action);
                    console.log('Form data:', urlEncodedData.toString());

                    const response = await fetch(form.action, {
                        method: 'POST',
                        body: urlEncodedData.toString(),
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        redirect: 'follow'
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        const errorDiv = document.createElement('div');
                        errorDiv.classList.add('alert-warning');
                        errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i> ${errorText}`;
                        
                        let targetSection = null;
                        if (form.classList.contains('rating-form') || form.classList.contains('delete-rating-form')) {
                            targetSection = document.querySelector('.movie-rating-section');
                        } else if (form.classList.contains('review-form') || form.classList.contains('delete-review-form')) {
                            targetSection = document.querySelector('.reviews-section');
                        }
                        
                        if (targetSection) {
                            const existingError = targetSection.querySelector('.alert-warning');
                            if (existingError) {
                                existingError.remove();
                            }
                            if (targetSection.classList.contains('reviews-section')) {
                                const reviewsHeader = targetSection.querySelector('.reviews-header');
                                if (reviewsHeader) {
                                    targetSection.insertBefore(errorDiv, reviewsHeader);
                                } else {
                                    targetSection.prepend(errorDiv);
                                }
                            } else {
                                targetSection.prepend(errorDiv);
                            }
                        }
                        return;
                    }

                    if (form.classList.contains('delete-form') && form.closest('.credit-item')) {
                        const creditItem = form.closest('.credit-item');
                        const creditsRow = creditItem.parentElement;
                        creditItem.remove();

                        if (creditsRow && creditsRow.querySelectorAll('.credit-item').length === 0 && creditsList) {
                            const selectedRole = roleSelect ? roleSelect.value : null;
                            if (selectedRole) {
                                filterCredits(selectedRole);
                            }
                        }
                    } else {
                        sessionStorage.setItem('movieScrollY', window.scrollY.toString());
                        window.location.reload();
                    }
                } catch (error) {
                    console.error(error);
                    alert('Unable to process your request. Please try again.');
                } finally {
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalButtonContent;
                    }
                }
            });
        });

        const ratingButtons = document.querySelectorAll('.rating-button');
        ratingButtons.forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault();
                event.stopPropagation();
                const form = this.closest('form.rating-form');
                if (form) {
                    const radio = this.previousElementSibling;
                    if (radio && radio.type === 'radio') {
                        radio.checked = true;
                        const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                        form.dispatchEvent(submitEvent);
                    }
                }
            });
        });

        const ratingRadios = document.querySelectorAll('.rating-radio');
        ratingRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                const form = this.closest('form.rating-form');
                if (form) {
                    form.requestSubmit();
                }
            });
        });

        function toggleEditReview() {
            const reviewItem = document.querySelector('.my-review');
            if (!reviewItem) return;
            
            const display = reviewItem.querySelector('.review-display');
            const editForm = reviewItem.querySelector('.review-edit-form');
            
            if (display && editForm) {
                const isEditing = editForm.style.display !== 'none';
                display.style.display = isEditing ? 'block' : 'none';
                editForm.style.display = isEditing ? 'none' : 'block';
            }
        }
    });
</script>
</body>
</html>

