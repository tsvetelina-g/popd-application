<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Details - popd</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/movie.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="/favicon.ico">
</head>
<body>
<header class="site-header">
    <div class="container">
        <div class="header-bar">
            <div class="logo-section">
                <a class="logo" href="/">
                    <img src="https://dl.dropboxusercontent.com/scl/fi/w1ql10wqc755r981aodun/Popd-logo-new.png?rlkey=ln1va7jaaqb5s8p7cqfi9d4v5&st=53c30za0"
                         alt="POPd Logo" class="logo-image">
                </a>
            </div>
            <div class="header-top">
                <div class="search-section">
                    <form class="search-bar" action="/find" method="get" role="search">
                        <input type="text" name="query"
                               placeholder="Search Movies or Artists"
                               aria-label="Search Movies or Artists">
                        <button type="submit">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </button>
                    </form>
                </div>

                <nav class="nav">
                    <span sec:authorize="isAnonymous()">
                        <a href="/login">Login</a>
                        <span class="nav-separator">|</span>
                        <a href="/register">Register</a>
                    </span>
                    <div class="dropdown" sec:authorize="isAuthenticated()">
                        <a href="/profile" class="profile-btn">
                            <i class="fa-solid fa-user"></i>
                            Profile
                            <i class="fa-solid fa-chevron-down"></i>
                        </a>
                        <div class="dropdown-menu">
                            <a href="/profile">Profile</a>
                            <a href="/logout">Logout</a>
                        </div>
                    </div>
                    <span class="nav-separator" sec:authorize="hasRole('ADMIN')">|</span>
                    <div class="dropdown" sec:authorize="hasRole('ADMIN')">
                        <a href="/admin" class="profile-btn">
                            <i class="fa-solid fa-gear"></i>
                            Admin
                            <i class="fa-solid fa-chevron-down"></i>
                        </a>
                        <div class="dropdown-menu">
                            <a href="/movie/add">Add Movie</a>
                            <a href="/artist/add">Add Artist</a>
                            <a href="/admin/users">Manage Users</a>
                            <a href="/admin">Admin Panel</a>
                        </div>
                    </div>
                    <a href="/movies" class="nav-button">Movies</a>
                </nav>
            </div>
        </div>
    </div>
</header>

<main class="container">
    <section class="movie-details-section">
        <div class="movie-container">
            <!-- Movie Header -->
            <div class="movie-header"
                 th:style="${movie.backgroundImage != null and !#strings.isEmpty(movie.backgroundImage)} ? '--bg-image-url:url(' + ${movie.backgroundImage} + '); --show-overlay:1;' : '--bg-image-url:none; --show-overlay:0;'">
                <div class="movie-poster">
                    <img th:src="${movie.posterUrl != null and !#strings.isEmpty(movie.posterUrl) ? movie.posterUrl : 'https://dl.dropboxusercontent.com/scl/fi/n6js2mekqny5wlsr8pl7k/User-image-default.png?rlkey=snhcvubwp3rpko1ei3sotym0u&st=q23rykyl'}"
                         alt="Movie poster" class="poster-image">
                </div>

                <div class="movie-info">
                    <h1 class="movie-title" th:text="${movie.title}">Movie Title</h1>

                    <div class="movie-meta">
                        <div class="meta-item">
                            <i class="fas fa-calendar"></i>
                            <span th:text="${movie.releaseDate != null ? 'Release date: ' + #temporals.format(movie.releaseDate, 'MMMM dd, yyyy', T(java.util.Locale).ENGLISH) : 'N/A'}">2024</span>
                        </div>
                        <div class="meta-item">
                            <img src="https://dl.dropboxusercontent.com/scl/fi/wwhw715m7c048f2zv4bsb/popcorn.png?rlkey=54m7mxucv9d9wnyodx5j1xble&st=z6990uik"
                                 alt="Popcorn" class="popcorn-icon-small">
                            <span>4.5</span>
                        </div>
                    </div>

                    <div class="movie-meta-side">
                        <div class="movie-meta-left-data">


                            <div class="genres-list" th:if="${!movie.genres.isEmpty()}">
                                <span th:each="genre : ${movie.genres}" class="genre-tag"
                                      th:text="${genre.name}">Action</span>
                            </div>

                            <div class="movie-description"
                                 th:if="${movie.description != null and !#strings.isEmpty(movie.description)}">
                                <h3 class="section-title">About</h3>
                                <p class="description-text" th:text="${movie.description}">Movie description goes
                                    here.</p>
                            </div>
                        </div>

                        <!-- Movie Stats -->
                        <div class="movie-stats">
                            <div class="stat-item">
                                <span class="stat-number">150</span>
                                <span class="stat-label">Total Ratings</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number">45</span>
                                <span class="stat-label">Reviews</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number" th:text="${usersWatchedCount}">320</span>
                                <span class="stat-label">Users Watched</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="movie-actions">
                <form sec:authorize="isAuthenticated()" th:if="${!movieIsInWatchlist}"
                      th:action="@{'/movie/' + ${movie.getId()} + '/watchlist'}"
                      th:method="post" class="inline-form">
                    <button type="submit" class="action-button add-to-watchlist-button">
                        <i class="fas fa-plus-circle"></i>
                        Add to Watchlist
                    </button>
                </form>
                <form sec:authorize="isAuthenticated()" th:if="${movieIsInWatchlist}"
                      th:action="@{'/movie/' + ${movie.id} + '/delete-from-watchlist'}"
                      th:method="delete" class="inline-form">
                    <input type="hidden" name="_method" value="delete">
                    <button type="submit" class="action-button add-to-watchlist-button added-to-watchlist-button">
                        <i class="fas fa-check-circle accent-icon"></i>
                        Added to Watchlist
                    </button>
                </form>
                <form sec:authorize="isAuthenticated()" th:if="${!isWatched}"
                      th:action="@{'/movie/' + ${movie.id} + '/watched'}" th:method="post"
                      class="inline-form">
                    <button type="submit" class="action-button add-to-watched-button">
                        <i class="fas fa-check-circle"></i>
                        Mark as Watched
                    </button>
                </form>
                <form sec:authorize="isAuthenticated()" th:if="${isWatched}"
                      th:action="@{'/movie/' + ${movie.id} + '/delete-watched'}" th:method="delete"
                      class="inline-form">
                    <input type="hidden" name="_method" value="delete">
                    <button type="submit" class="action-button add-to-watched-button watched-button">
                        <i class="fas fa-eye accent-icon"></i>
                        Watched
                    </button>
                </form>

                <div sec:authorize="isAnonymous()" class="guest-actions-wrapper">
                    <a href="/login" class="action-button add-to-watchlist-button guest-watchlist-button">
                        <i class="fas fa-plus-circle"></i>
                        Log in to Manage Watchlist
                    </a>
                </div>

                <form sec:authorize="hasRole('ADMIN')" th:action="@{'/movie/' + ${movie.getId()} + '/edit'}"
                      method="get" class="inline-form">
                    <button type="submit" class="action-button edit-button">
                        <i class="fas fa-edit"></i>
                        Edit Movie
                    </button>
                </form>
            </div>
        </div>


        <div class="movie-content-section">

            <!-- Rating Section -->
            <div class="movie-rating-section">
                <h3 class="section-title-rating">Your Rating</h3>
                <div class="rating-options" sec:authorize="isAuthenticated()">
                    <button class="rating-button" type="button" value="10">
                        <span class="rating-number">10</span>
                        <img src="https://dl.dropboxusercontent.com/scl/fi/wwhw715m7c048f2zv4bsb/popcorn.png?rlkey=54m7mxucv9d9wnyodx5j1xble&st=z6990uik"
                             alt="10" class="popcorn-rating-icon">
                    </button>
                    <button class="rating-button" type="button" value="9">
                        <span class="rating-number">9</span>
                        <img src="https://dl.dropboxusercontent.com/scl/fi/wwhw715m7c048f2zv4bsb/popcorn.png?rlkey=54m7mxucv9d9wnyodx5j1xble&st=z6990uik"
                             alt="9" class="popcorn-rating-icon">
                    </button>
                    <button class="rating-button" type="button" value="8">
                        <span class="rating-number">8</span>
                        <img src="https://dl.dropboxusercontent.com/scl/fi/wwhw715m7c048f2zv4bsb/popcorn.png?rlkey=54m7mxucv9d9wnyodx5j1xble&st=z6990uik"
                             alt="8" class="popcorn-rating-icon">
                    </button>
                    <button class="rating-button" type="button" value="7">
                        <span class="rating-number">7</span>
                        <img src="https://dl.dropboxusercontent.com/scl/fi/wwhw715m7c048f2zv4bsb/popcorn.png?rlkey=54m7mxucv9d9wnyodx5j1xble&st=z6990uik"
                             alt="7" class="popcorn-rating-icon">
                    </button>
                    <button class="rating-button" type="button" value="6">
                        <span class="rating-number">6</span>
                        <img src="https://dl.dropboxusercontent.com/scl/fi/wwhw715m7c048f2zv4bsb/popcorn.png?rlkey=54m7mxucv9d9wnyodx5j1xble&st=z6990uik"
                             alt="6" class="popcorn-rating-icon">
                    </button>
                    <button class="rating-button" type="button" value="5">
                        <span class="rating-number">5</span>
                        <img src="https://dl.dropboxusercontent.com/scl/fi/wwhw715m7c048f2zv4bsb/popcorn.png?rlkey=54m7mxucv9d9wnyodx5j1xble&st=z6990uik"
                             alt="5" class="popcorn-rating-icon">
                    </button>
                    <button class="rating-button" type="button" value="4">
                        <span class="rating-number">4</span>
                        <img src="https://dl.dropboxusercontent.com/scl/fi/wwhw715m7c048f2zv4bsb/popcorn.png?rlkey=54m7mxucv9d9wnyodx5j1xble&st=z6990uik"
                             alt="4" class="popcorn-rating-icon">
                    </button>
                    <button class="rating-button" type="button" value="3">
                        <span class="rating-number">3</span>
                        <img src="https://dl.dropboxusercontent.com/scl/fi/wwhw715m7c048f2zv4bsb/popcorn.png?rlkey=54m7mxucv9d9wnyodx5j1xble&st=z6990uik"
                             alt="3" class="popcorn-rating-icon">
                    </button>
                    <button class="rating-button" type="button" value="2">
                        <span class="rating-number">2</span>
                        <img src="https://dl.dropboxusercontent.com/scl/fi/wwhw715m7c048f2zv4bsb/popcorn.png?rlkey=54m7mxucv9d9wnyodx5j1xble&st=z6990uik"
                             alt="2" class="popcorn-rating-icon">
                    </button>
                    <button class="rating-button" type="button" value="1">
                        <span class="rating-number">1</span>
                        <img src="https://dl.dropboxusercontent.com/scl/fi/wwhw715m7c048f2zv4bsb/popcorn.png?rlkey=54m7mxucv9d9wnyodx5j1xble&st=z6990uik"
                             alt="1" class="popcorn-rating-icon">
                    </button>
                </div>
                <div class="rating-login-prompt" sec:authorize="isAnonymous()">
                    <a href="/login" class="action-button add-to-watchlist-button">
                        <img src="https://dl.dropboxusercontent.com/scl/fi/wwhw715m7c048f2zv4bsb/popcorn.png?rlkey=54m7mxucv9d9wnyodx5j1xble&st=z6990uik"
                             alt="Popcorn" class="popcorn-icon-small">
                        Log in to Rate This Movie
                    </a>
                </div>
            </div>
        </div>

        <div class="movie-container">
            <!-- Movie Credits -->
            <div class="movie-credits-section">
                <div class="credits-section">
                    <div class="credits-header">
                        <div class="credits-header-left">
                            <h2 class="credits-title">Credits</h2>
                            <a sec:authorize="hasRole('ADMIN')" th:href="'/credit/' + ${movie.id} + '/edit'"
                               class="action-button edit-credits-button">
                                <i class="fas fa-edit"></i>
                                Edit Credits
                            </a>
                        </div>
                        <select id="role-select" class="role-select">
                            <option value="ACTOR" selected>Cast</option>
                            <option value="DIRECTOR">Director</option>
                            <option value="WRITER">Writer</option>
                            <option value="PRODUCER">Producer</option>
                            <option value="CINEMATOGRAPHER">Cinematographer</option>
                            <option value="EDITOR">Editor</option>
                            <option value="COMPOSER">Composer</option>
                            <option value="COSTUME_DESIGNER">Costume Designer</option>
                            <option value="PRODUCTION_DESIGNER">Production Designer</option>
                            <option value="VISUAL_EFFECTS">Visual Effects</option>
                            <option value="SOUND_DESIGNER">Sound Designer</option>
                            <option value="MAKEUP_ARTIST">Makeup Artist</option>
                            <option value="STUNT_COORDINATOR">Stunt Coordinator</option>
                            <option value="CHOREOGRAPHER">Choreographer</option>
                            <option value="CASTING_DIRECTOR">Casting Director</option>
                        </select>
                    </div>
                    <div id="credits-list" class="credits-list">
                        <p class="no-credits-message" style="display: none;">No credits yet.</p>

                        <!-- Credit items for each role -->
                        <div th:if="${creditsByRole != null and !creditsByRole.isEmpty()}">
                            <div th:each="roleEntry : ${creditsByRole}" class="credits-images-row">
                                <div th:each="credit : ${roleEntry.value}"
                                     class="credit-item"
                                     th:attr="data-role=${roleEntry.key.name()}">
                                    <a th:href="@{'/artist/' + ${credit.artist.id}}" class="credit-link">
                                        <div class="credit-image-container">
                                            <img th:src="${credit.artist.imageUrl != null and !#strings.isEmpty(credit.artist.imageUrl) ? credit.artist.imageUrl : 'https://dl.dropboxusercontent.com/scl/fi/n6js2mekqny5wlsr8pl7k/User-image-default.png?rlkey=snhcvubwp3rpko1ei3sotym0u&st=q23rykyl'}"
                                                 th:alt="${credit.artist.name}"
                                                 class="credit-artist-image">
                                        </div>
                                        <span class="credit-artist-name"
                                              th:text="${credit.artist.name}">Artist Name</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!--        <div class="movie-container">-->
        <!-- Reviews/Comment Section -->
        <div class="reviews-section">
            <div class="reviews-header">
                <h3 class="section-title">User Reviews</h3>
                <a th:href="@{'/movies/' + ${movie.id} + '/reviews'}" class="action-button view-all-reviews-button">
                    <i class="fas fa-eye"></i>
                    View All Reviews
                </a>
            </div>
            <div class="reviews-list">
                <div class="review-item">
                    <div class="review-header">
                        <div class="reviewer-info">
                            <span class="reviewer-name">John Doe</span>
                            <span class="review-date">Jan 15, 2024</span>
                        </div>
                    </div>
                    <div class="review-content">
                        <p>This was an amazing movie! The cinematography was stunning and the acting was
                            top-notch.</p>
                    </div>
                </div>
                <div class="review-item">
                    <div class="review-header">
                        <div class="reviewer-info">
                            <span class="reviewer-name">Jane Smith</span>
                            <span class="review-date">Jan 10, 2024</span>
                        </div>
                    </div>
                    <div class="review-content">
                        <p>Absolutely loved it! One of the best films I've seen this year.</p>
                    </div>
                </div>
            </div>

            <div class="review-form-section">
                <h4 class="section-title review-form-title">Write a Review</h4>
                <form class="review-form" sec:authorize="isAuthenticated()">
                        <textarea class="review-textarea"
                                  placeholder="Share your thoughts about this movie..."></textarea>
                    <button type="submit" class="action-button submit-review-button">
                        <i class="fas fa-paper-plane"></i>
                        Submit Review
                    </button>
                </form>
                <div class="review-login-prompt" sec:authorize="isAnonymous()">
                    <a href="/login" class="action-button submit-review-button">
                        <i class="fas fa-paper-plane"></i>
                        Log in to Write a Review
                    </a>
                </div>
            </div>
        </div>

    </section>
</main>

<footer class="site-footer">
    <div class="container">
        <p>&copy; <span>2025</span> popd</p>
    </div>
</footer>

<script>
    // Credits filtering functionality + AJAX form handling
    document.addEventListener('DOMContentLoaded', function () {
        const roleSelect = document.getElementById('role-select');
        const creditsList = document.getElementById('credits-list');

        if (roleSelect && creditsList) {
            const creditItems = creditsList.querySelectorAll('.credit-item');
            const noCreditsMessage = creditsList.querySelector('.no-credits-message');

            function filterCredits(selectedRole) {
                if (!selectedRole) {
                    return;
                }

                // Hide all credit items
                creditItems.forEach(item => {
                    item.style.display = 'none';
                });

                // Hide the "no credits" message initially
                if (noCreditsMessage) {
                    noCreditsMessage.style.display = 'none';
                }

                // Show credit items for the selected role
                let foundCredits = false;
                creditItems.forEach(item => {
                    if (item.getAttribute('data-role') === selectedRole) {
                        item.style.display = 'flex';
                        foundCredits = true;
                    }
                });

                // Show message if no credits found for selected role
                if (!foundCredits && noCreditsMessage) {
                    noCreditsMessage.style.display = 'block';
                }
            }

            // Set up change event listener
            roleSelect.addEventListener('change', function () {
                filterCredits(this.value);
            });

            // Initialize with "Actor" selected (default)
            filterCredits(roleSelect.value);
        }

        const storedScrollY = sessionStorage.getItem('movieScrollY');
        if (storedScrollY !== null) {
            window.scrollTo(0, parseInt(storedScrollY, 10));
            sessionStorage.removeItem('movieScrollY');
        }

        const ajaxFormSelectors = [
            'form.inline-form[action*="/watchlist"]',
            'form.inline-form[action*="/watched"]',
            'form.inline-form[action*="/delete-from-watchlist"]',
            'form.inline-form[action*="/delete-watched"]',
            'form.delete-form[action*="/credit/"]'
        ];

        const ajaxForms = document.querySelectorAll(ajaxFormSelectors.join(', '));

        ajaxForms.forEach(form => {
            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                const submitButton = form.querySelector('button[type="submit"]');
                const originalButtonContent = submitButton ? submitButton.innerHTML : null;

                if (submitButton) {
                    submitButton.disabled = true;
                }

                try {
                    const formData = new FormData(form);
                    const response = await fetch(form.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        redirect: 'follow'
                    });

                    if (!response.ok) {
                        throw new Error('Request failed');
                    }

                    if (form.classList.contains('delete-form') && form.closest('.credit-item')) {
                        const creditItem = form.closest('.credit-item');
                        const creditsRow = creditItem.parentElement;
                        creditItem.remove();

                        if (creditsRow && creditsRow.querySelectorAll('.credit-item').length === 0 && creditsList) {
                            const selectedRole = roleSelect ? roleSelect.value : null;
                            if (selectedRole) {
                                filterCredits(selectedRole);
                            }
                        }
                    } else {
                        sessionStorage.setItem('movieScrollY', window.scrollY.toString());
                        window.location.reload();
                    }
                } catch (error) {
                    console.error(error);
                    alert('Unable to process your request. Please try again.');
                } finally {
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalButtonContent;
                    }
                }
            });
        });
    });
</script>
</body>
</html>

